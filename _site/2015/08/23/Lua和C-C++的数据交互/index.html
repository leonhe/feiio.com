<!DOCTYPE html>
<html>

   <head>
   <meta charset="utf-8">
   
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google-site-verification" content="XN4YmHgE76jTp2kNQ9qnsVSApl6yIQBzdyLe0BnbFks" />

  <title>Lua和C/C++的数据交互</title>
  <meta name="description" content="近日重新复习了下C\C++和Lua之间的数据交互知识,在这里也做一个简单的记录来作为以后的参考.">
<!--<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">-->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/bootstrap-theme.min.css">

  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/holder.min.js" type='text/javascript'></script>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="canonical" href="http://localhost:4000/2015/08/23/Lua%E5%92%8CC-C++%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92/">
  <link rel="alternate" type="application/rss+xml" title="阿拉伯的鞋匠" href="http://localhost:4000/feed.xml">
</head>

  <body>

    <header class="navbar navbar-default navbar-fixed-top" id="top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">阿拉伯的鞋匠</a>
    </div>

    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">

      <ul class="nav navbar-nav">
	<li > <a  href="/">Home</a></li>
	
          
        <li > <a  href="/about/">About Me</a></li>
          
          
          
        <li > <a  href="/archive/">Archive</a></li>
          
          
          
          
          
          
          
        <li > <a  href="/link/">Link</a></li>
          
          
          
          
          
          

      </ul>
  </div>
</nav>






</header>

    
      <div class="jumbotron masthead" role="main">
	<div class="row">
	  <div class="col-md-8 col-md-offset-2">
	    <div class="container ">
	        <div class="panel panel-default">
    <div class="panel-body">
      <div id="post" >
	<p><h2 >Lua和C/C++的数据交互</h2>
	  <small class="text-muted">
	    发表于&nbsp;<time datetime="2015-08-23T20:52:42+08:00" itemprop="datePublished">Aug 23, 2015</time>
	  </small>
	</p>
	
	<p>
	  
	  <a href='/archive/#游戏开发'><span class="label label-danger">游戏开发</span></a>
	
	</p>
	<hr/>

	    <p>近日重新复习了下C\C++和Lua之间的数据交互知识,在这里也做一个简单的记录来作为以后的参考.</p>

<h3 id="lua">Lua栈操作的介绍</h3>
<p>Lua是一种嵌入式的脚本语言,不是独立运行的程序它可以通过链接对其他语言进行扩展，或让其他的语言来使用Lua的功能.其中包括使用lua作为库存在于C中或Lua作为主导权C作为一个库来使用.
<!--more-->
lua和C语言的交互都是在一个虚拟栈进行的,所有的API操作都是对栈上的数据进行交互.无论是C到Lua的操作还是Lua到C的操作.这里会存在两个问题</p>
<ol>
  <li>动态类型和静态类型之间的区别，lua是动态性的语言，而C是静态语言</li>
  <li>自动内存管理和手动内存管理的区别.</li>
</ol>

<p>lua没有采用C语言的联合来解决动态和静态的区别，其原因是不仅为C一门语言设计的保持Lua的宿主可以是任何一门语言。其次Lua是有垃圾回收机制的如果lua table保持在C变量中，Lua引擎则无法搜索出来回收.所以Lua会使用一个抽象的棧来对Lua和C之间的数据交互.</p>

<p>Lua的栈严格按照（LIFO）先出后进的规范来操作栈,栈中任何元素都保存着lua中的任何类型:</p>
<ol>
  <li>获得lua中的一个值,调用Lua API函数,Lua会将指定的值压入栈，</li>
  <li>要将一个值传给Lua时则先要将这个值压入栈，调用Lua API函数,Lua则会把获取该值并将其从栈中弹出.</li>
</ol>

<p>压栈操作会把第一个压入的元素索引标记为1，第二个为2，依次推至栈顶，使用负数来访问栈中元素，-1表示栈顶的元素.</p>

<h3 id="api">相关API</h3>

<pre>
压入栈:lua_push* (..)
检查元素类型: lua_is*(..)
栈中取出值: lua_to*()
检查栈是否有足够的空间:lua_checkstack(lua_State *l,int size);
返回栈中元素个数:lua_gettop(..)
将栈顶设置为一个指定位置: lua_settop(..)
栈中弹出指定个数的元素:lua_pop(..)
将索引上的值副本压入栈:lua_pushvalue(..)
删除栈中指定位置的元素:lua_remove(..)
移动指定元素空间开辟一个槽空间，将栈顶元素移到该位置: lua_insert(..)
移动栈顶的元素到指定位置:lua_replace(..)
*: string\nil\number\boolean\integer 
</pre>

<h3 id="clua">C中调用Lua</h3>
<p>比如lua文件中有一个全局变量的table: conf={w=20,h=10}</p>
<pre>

lua_stack* L = luaL_new_state();
luaL_openlibs(L);

lua_dofile("lua文件");

lua_getglobal(lua_stack*,"conf");
if(!lua_istable(lua_stack*,-1))
{
  printf("conf全局变量不是一个table")
}
//获取W的值
lua_pushstring(L,"w");
lua_gettable(L,-2)
if(!lua_isnumber(L,-1))
{
 printf("%s不是一个数字","w");
 }
 int w_val = lua_tonumber(L,-1);
 lua_pop(L,1);

//调用lua中方法
lua_getglobal(L,"方法名");
//这里可以压入参数值
lua_pushstring(L,"参数值")
//状态引用,参数个数,是否有返回值
if(lua_pcall(L,1,1,0)!=0)
{
  printf("函数调用失败 Error:%s",lua_tostring(L,-1));
}
//获取返回值
if(lua_isnumber(L,-1))
{
  int res_value = lua_tonumber(L,-1);
}
lua_close(L);

</pre>

<h3 id="luacc">Lua调用C/C++</h3>
<h4 id="cclua">注册C/C++函数到Lua中</h4>

<pre>
int mysin(lua_State* L)
{
//获取lua中的值
  int str = luaL_checknumber(L,1);
  printf("lua中传入参数的值:%d",str);
//获取第二个参数,调用lua方法
if(lua_isfunction(L,2))
{
   if(lua_pcall(L,0,0,0)!=0){
      printf("调用函数出错");
    }
}

//压入返回值到lua中
lua_pushstring(L,"这里是返回给lua的值");

return 1;
}

....

//压入函数到栈中
lua_pushcfunction(L,mysin);
lua_setglabal(L,"mysin");
....

lua中直接调用: local res=mysin(10,function()
   print("这里是参数函数")
end);


</pre>

<h4 id="luacc-1">Lua调用C/C++中的自定义类型</h4>
<pre>
//自定类型绑定到lua中
struct MyType{
  int size;
}

static int mytype_new(lua_State* L)
{
MyType** mytype = (MyType**)lua_newuserdata(L,sizeof(MyType*));
*mytype=new MyType();
luaL_getmetatable(L,"feiio.MyType");
lua_setmetatable(L,-2);
   return 1;
}


static int mytype_getType(lua_State*L)
{
//这里获取创建的对象
MyType **mytype=(MyType**)luaL_checkudata(L,1,"feiio.MyType");
int size = (*mytype)-&gt;size;
lua_pushnumber(L,size);
 
 return 1;
 }

//Lua执行对象回收机制销毁对象时调用
static int mytype_gc(lua_State* L)
{
MyType** mytype = (MyType**)luaL_checkudata(L,1,"feiio.MyType");
if(mytype)
{
  delete mytype;
  }
  return 0;
}

int initMyType(lua_State* L)
{
static const luaL_Reg mylib[]={
{"new",mytype_new},
{NULL,NULL}
};

static const luaL_Reg myfunc[]={
{"getType",mytype_getType},
{"__gc",mytype_gc},
{NULL,NULL}
}
//实现面向对象的支持
luaL_newmetatable(L,"feiio.MyType");
lua_pushvalue(L,-1);
lua_setfield(L,-2,"__index");
lua_setfuncs(L,myfunc,0);
  luaL_newlib(L,mylib);


return 1;
  }

//main函数中
.....
initMyType(L);
luaL_requiref(L,"MyType",createType,1);
lua_settop(L,0)
.....

//Lua中调用
local mytype=MyType.new()
//面向对象的方式获取
mytype:getType()
</pre>

<h3 id="section">相关资料</h3>
<p><a href="http://lua-users.org/wiki/SimplerCppBinding">使用C++模板来绑定Lua</a>
<a href="http://zilongshanren.com/blog/2014-08-11-bind-a-simple-cpp-class-in-lua.html#%E7%BB%91%E5%AE%9Ac%E7%B1%BB">Lua教程:绑定一个简单的C++类(6)</a></p>

	<p class="text-center text-warning"> ---------------> <b>END</b> <--------------- </p>
											  
									

		<p><b>tags:</b></a>
		  
		  <span class="label label-default">Lua</span>
		  
		  <span class="label label-default">C++</span>
		  </p>

							    
							    <table class="table">
     <tbody><tr>
          <td><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png"></a></td>
	       <td>
	            本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可。
		         </td>
			      </tr>
</tbody></table>

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="2015/08/23/Lua和C/C++的数据交互/" data-title="Lua和C/C++的数据交互" data-url="https://feiio.com/2015/08/23/Lua%E5%92%8CC-C++%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"heyuanfei"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
							    </div>
  </div>

</div>

      	    </div>
	  </div>
	</div>
      </div>
      <div class="container footer">
  <div class="row">
    <div class="col-md-10">
      <small class="text-muted">© 2012-2016 <a href="/">feiio.com</a>, all rights reserved &nbsp;&nbsp;version:1.0.1</small>
    </div>
    <div class="col-md-2">
      <small class="text-muted"> 沪ICP备14014318号-2</small>
      </div>
   </div>
 </div>
   <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-66653712-1', 'auto');
      ga('send', 'pageview');

   </script>

  </body>

</html>
